## VPC(Virtual Private Cloud)

### - VPC 개념

<center>
  <image src='./images/nonVPC.png' width=500 />
</center>

- VPC가 없다면 EC2 인스턴스들이 서로 거미줄처럼 연결되고 인터넷과 연결된다.
  - 시스템의 복잡도를 상승시킴
  - 하나의 인스턴스만 추가되도 모든 인스턴스를 수정해야하는 불편함을 유발한다.

<center>
  <image src='./images/VPC.png' width=500 />
</center>

- VPC를 적용하면 위 그림과 같이 각각의 VPC는 독립된 네트워크처럼 작동한다.

---

## VPC(Virtual Private Cloud)

### - VPC를 구축하는 과정

<center>
  <image src='./images/howVPC.png' width=500 />
</center>
    
- VPC를 구성하기 위해서는 VPC의 IP범위를 RFC1918이라는 사설IP 대역에 맞춰 구축해야한다.
  - 사설IP란? 인터넷을 위해 사용하는 것이 아닌 우리끼리 사용하는 IP주소 대역.
  > 예를 들면, 누군가에게 "안방에서 리모컨 좀 가져다달라"하면 나는 옆집을 가는게 아닌 우리집에 있는 "안방"으로 찾아간다. 안방이 사설IP, 우리집 주소가 공용IP.<br>
  > 옆집도 안방이 있고 우리집도 안방이 있지만 서로 안방을 들었을 때 헷갈리지 않는다.
  > "안방", "작은방", "큰방" 처럼 내부에서 쓰는 주소를 사설IP 대역이라고 부르며 내부 네트워크내에서 위치를 찾아갈 때 사용한다. 물론 치킨 시킬 때는 도로명주소(공용IP)를 알려주면 되고, 같은 집에 사는 내가 동생한테 갈 때는 동생방(사설IP)로 찾아간다.

- VPC에서 사용하는 사설 IP 대역

  - 10.0.0.0 ~ 10.255.255.255 (10/8 prefix)
  - 172.16.0.0 ~ 172.31.255.255 (182.16/12 prefix)
  - 192.168.0.0 ~ 192.168.255.255 (192.168/16 prefix)

- 사설 IP 대역 외의 IP를 CIDR로 지정할 경우 해당 IP의 요청은 VPC 내부로 라우트 되어 사설 IP를 찾아가므로 인터넷 IP에 접근하는 것이 원천적으로 불가능하게 된다. 예를 들어 CIDR을 52.12.0.0/16로 설정할 경우 해당 IP로 인터넷 접근이 불가능하다.

---

## VPC(Virtual Private Cloud)

### - IPv4 CIDR: IP의 범위를 지정하는 방식

- CIDR 블록은 IP 주소와 슬래시(/) 뒤에 따라오는 넷마크 숫자로 구성되어 있다.
- 넷마크 숫자는 IP 범위를 나타낸다.
- 이 숫자가 32이면 앞에 기술된 IP 정확히 하나를 가리킨다. 예를 들어 192.168.0.0/32는 192.168.0.0을 가리킨다.
- 범위는 지정된 IP부터 2^(32-n)개가 된다. 예를 들어 뒤의 숫자가 24라면 2^(32-24)=256개의 IP 주소를 의미한다. 192.168.0.0/24는 192.168.0.0에서 192.168.1.255까지의 IP를 의미한다.
  <br>
- 클라우드에서 생성한 자원들은 기본적으로 특정 네트쿼크 위에서 생성되며 이에 접근하기 위한 프라이빗 IP를 가진다.
- 리소스들은 특정 VPC위에서 만들어지므로 VPC CIDR 범위 안에서 적한 IP를 할당 받게된다. 예를 들어 192.168.0.0/24 CIDR 블록을 가진 VPC에서 생성한 EC2 인스턴스는 192.168.0.127이라는 IP를 할당 받을 수 있다.

---

## VPC(Virtual Private Cloud)

### - 서브넷

<center>
  <image src='./images/subnet.png' width=700 />
</center>

- VPC를 만들었다면 이제 서브넷을 만들 수 있다.
- 서브넷은 더 많은 네트워크망을 만들기 위해서 VPC를 잘게 쪼개는 과정이다.

---

## VPC(Virtual Private Cloud)

### - 라우팅 테이블

#### : 네트워크 요청이 발생하면 데이터는 우선 라우터로 향한다. 라우터란 목적지이고 라우팅테이블은 각 목적지에 대한 이정표다.

<center>
  <image src='./images/routingtable.png' width=700 />
</center>

- 서브넷A의 라우팅테이블은 172.31.0.0/16 을 타켓한다. 즉, VPC 안의 네트워크 범위를 갖는 네트워크 요청은 로컬에서 찾도록 되어 있다.
- 하지만 그 외에 외부로 통하는 트래픽을 처리할 수 없다. 이 때 **인터넷 게이트웨이**를 사용한다.
- default 규칙: VPC의 CIDR을 목적지로 하는 경우 타깃이 local.
- **인터넷을 연결하거나 다른 VPC와 통신하기 위해서는 라우트 테이블에 라우트 규칙을 추가적으로 정의해야한다.**

---

## VPC(Virtual Private Cloud)

### - 인터넷 게이트웨이: VPC와 인터넷을 연결해주는 하나의 관문

<center>
  <image src='./images/internetgateway.png' width=800 />
</center>

- 인터넷과 연결되어 있는 서브넷을 퍼블릭 서브넷, 인터넷과 연결되지 않은 서브넷을 프라이빗 서브넷이라고 한다.
- 서브넷B의 라우팅 테이블을 보면 0.0.0.0/0가 정의되어 있는데, 모든 트래픽에 대하여 IGA(인터넷 게이트웨이) A로 향하게 되어 있다.
- 라우팅 테이블은 가장 먼저 목적지의 주소가 172.31.0.0/16에 매칭되는지를 확인한 후 매칭되지 않는다면 IGA A로 보낸다.

---

## VPC(Virtual Private Cloud)

### - 네트워크 ACL과 보안그룹

#### : 방화벽과 같은 역할을 하며 인바운드 / 아웃바운드 트래픽 보안 정책을 설정한다.

<center>
  <image src='./images/networkACL.png' width=600 />
</center>

- 네트워크 ACL
  - Stateless하게 작동하며 **모든 트래픽이 기본 설정**되어 있기 때문에 불필요한 트래픽을 막도록 적용해야한다. 서브넷 단위로 적용되며 리소스별로는 설정할 수 없다.
  - 네트워크 ACL과 보안그룹이 충돌한다면 보안그룹이 더 높은 우선순위를 갖는다.
- 보안그룹
  - Stateful한 방식으로 동작하는 **모든 허용을 차단**하도록 기본 설정되어 있다. 필요한 설정은 별도로 허용해주면 된다.
  - 네트워크 ACL과 다르게 각각의 보안그룹별로 별도의 트래픽을 설정할 수 있으며 서브넷에도 설정할 수 있고, 각각의 EC2 인스턴스에서도 적용할 수 있다.

---

## VPC(Virtual Private Cloud)

### - NAT 게이트웨이

#### : 파라이빗 서브넷이 인터넷과 통신하기 위한 아웃바운드 인스턴스

<center>
  <image src='./images/NATgateway.png' width=300 />
</center>

- 프라이빗 네트워크가 외부에서 요청되는 인바운드는 필요없더라도 인스턴스의 펌웨어나 혹은 주기적인 업데이트가 필요하여 아웃바운드 트래픽만 허용되어야 할 경우가 있다.
- 이 때 퍼블릭 서브넷상에서 동작하는 NAT 게이트웨이는 프라이빗 서브넷에서 외부로 요청하는 아웃바운드 트래픽을 받아 인터넷 게이트웨이와 연결한다.

---

## VPC(Virtual Private Cloud)

### - DHCP 옵션셋(DHCP options set)

#### : TCP/IP 네트워크 상의 호스트로 설정 정보를 전달하는 DHCP 표준

- 이 기능을 사용하면 도메인 네임 서버, 도메인 네임, NTP 서버, NetBIOS 서버 등의 정보를 설정할 수 있다. 일반적으로 VPC 생성 시 만들어지는 DHCP 옵션셋을 그대로 사용한다.
